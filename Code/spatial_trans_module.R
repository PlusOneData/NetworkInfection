#' Spatial transmission Module
#'
#' At the start of each day it is assumed all rooms are not contaminated. Rooms are contaminated at
#' a given rate and decontaminated at a given rate. Individuals can be infected after spending
#' a certain amount of time in a room with a certain level of contamination.
#'
#' Emission rate  infection risk based on work by Buonanno et al. 
#' \url{https://www.sciencedirect.com/science/article/pii/S0160412020312800}
#' \url{https://www.sciencedirect.com/science/article/pii/S0160412020320675?via%3Dihub}
#' 
#' Important terms:
#' 
#' Quanta = a quantum is defined as the dose of airborne 
#' droplet nuclei required to cause infection in 63% of
#' susceptible persons.
#' 
#' Emission Rate
#' 
#' \deqn{ER_{q,j} = c_v*c_i*IR*\sum_{i=1}^4(N_{i,j}*V_i)}
#' 
#' \eqn{ER_{q,j}} = quanta emission rate = \eqn{quanta h^{-1}}
#' \eqn{c_v} = viral load in sputum = RNA copies per mL
#' \eqn{c_i} = conversion factor between quanta and infectious dose viral rna copies
#' \eqn{IR} = inhalation rate
#' \eqn{\sum_{i=1}^4(N_{i,j}*V_i)} = sum of different expiration types
#'
#' In this module, we have made simplifying assumptions about expiration types and 
#' inhalation rates - we assume they are homogeneous for all individuals. 
#'
#'Viral concentration
#'
#'\deqn{n(t) = \frac{ER_q*I}{IVRR*V}+(n_o+frac{ER_q*I}{IVRR})*frac{e^{IVRR*t}}{V}}
#'
#'\eqn{IVRR} = infectious viral removal rate (ventilation + decay + deposition)
#'\eqn{I} = number of infecitous individuals
#'\eqn{ER_q} = quanta emission rate
#'\eqn{V} = volume of space
#'\eqn{n_0} = initial concentration of virus
#'
#'Infection Risk 
#'
#'A funciton of exposure time
#'
#'\deqn{R = (1-e^{-IR\int_0^Tn(t)dt)}
#'
#'\eqn{IR} = inhalation rate
#'\eqn{T} = total time of exposure
#'
#'
#' @field rooms Dataframe of rooms with name, volume (m3), and airExchange (air exchanges per hour) attributes
#' @field inRate Numeric, inhalation rate for individuals (\eqn{m^3/hour})
#' @field emRate Numeric, rate of contamination by infectious individuals (\eqn{quanta/hour/person})
#' @export spat_tran
spat_tran <- setRefClass(
  "spatInf", #change this to create a new class
  fields = list( rooms="data.frame",
                 inRate="numeric",
                 emRate="numeric"
                 #schedule
  ),
  methods = list(
    init = function(g) {
      "give each node a schedule"
      # creating random schedules in 15 min blocks
      # need to add capacity attribute to rooms
      igraph::V(g)$schedule <- sample(rooms$name,32*igraph::vcount(g),replace = T) %>% 
                                split(., ceiling(seq_along(.)/32)) %>% 
                                purrr::map(.x=., function(x){
                                  paste(x,collapse = "")
                                }) %>% 
                                purrr::flatten_chr()
      
      "simulate spatial infections and movements"
      
      rooms$infStatus <- 0
      rooms$virusConc <- 0 
      
      g <- spatialTrans(g,rooms)
      
      return(g)
    },
    donext = function(g) {

      "simulate spatial infections and movements"
      rooms$infStatus <- 0
      rooms$virusConc <- 0 
      
      g <- spatialTrans(g,rooms)
      
      return(g)
    },
    spatialTrans = function(g,rooms){
      ## want to get location at time point 1 
      for(i in 1:32){
        # need to find where each node is at time step 1
        igraph::V(g)$currentLoc <- igraph::V(g)$schedule %>% 
          stringr::str_sub(.,start = i,end = i)
        
        # loop through each room
        for(room in rooms$name){
        nodes <- igraph::V(g)[currentLoc == room]
        
        "make sure there is someone in the room"
        
          if(length(nodes$relInf)!=0){
          
            df <- rooms %>% 
              filter(name == room)
            #how much sars-cov-2 is emitted into the room
            roomCon <- (sum(nodes$relInf*emRate))/df$volume
            
            #update virus concentration in room and remove
            # need to add decay and settling term here
            df$virusConc <- (df$virusConc + roomCon)/((df$airExchange/4)*df$volume) 
            
            infRisk <- infectionRisk(inRate/4,df$virusConc)
          
            ## get probInf given infProbReduction
            
            probInf <- nodes[infected == 0]$infProbReduction * infRisk
            
            if(length(probInf) > 0){
            
            ## get inf status
            infStatus <- rbinom(1,1,min(probInf,1))
            
            
            nodes[infected == 0][infStatus]$infected <- 1
            nodes[infected == 1]$color <- "red"
            
            igraph::V(g)[currentLoc == room] <- nodes
            }
            
            #replace values in room before exiting loop
            rooms[rooms$name == room,] <- df
          }
        }
      }
      
      return(g)
    },
    infectionRisk = function(inRate,roomConc){
      
      "infection risk is expressed as a percent"
      infRisk <- (1-exp(-inRate*roomConc))
      return(infRisk)
    }
  )
)